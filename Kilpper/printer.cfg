##################Creality Ender 3 S1 Klipper Config - 3DPrintBeginner###################
######Full guide: https://3dprintbeginner.com/how-to-install-klipper-on-ender-3-s1/######

# Include Jschuh's wonderful extended Klipper macros
# See https://github.com/jschuh/klipper-macros
[include klipper-macros.conf]

[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA5
position_endstop: -7  # My Ender 3 S1's homing end stop is off the bed edge,
position_min: -7      # so these move in the origin (0,0) by this amount
position_max: 258
homing_speed: 100

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: !PA6
position_endstop: -7  # My Ender 3 S1's homing end stop is off the bed edge,
position_min: -7      # so these move in the origin (0,0) by this amount
position_max: 230
homing_speed: 100

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 270
position_min: -5

[extruder]
max_extrude_only_distance: 100.0
max_extrude_cross_section: 2.1 # Increased defaults for fat purge lines
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16
rotation_distance: 7.4605248  # Started with 7.6190, measured and calculated 7.4605248 on 2/2/2024
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
#control: pid
#pid_Kp: 22.865
#pid_Ki: 1.292
#pid_Kd: 101.178
min_temp: 0
max_temp: 300 # High temp hot end replaced on my stock Ender 3 S1
# For pressure advance, see https://obico.io/blog/klipper-pressure-advance/
pressure_advance = 0.055 # Calculated .05 on 2/2/2024

# Suggested default values from ConnectedSensorsJohann - thank you so much!
[input_shaper]
shaper_freq_x: 46
shaper_freq_y: 39
shaper_type: ei

[filament_switch_sensor RunoutSensor]
pause_on_runout: False
runout_gcode: PAUSE
insert_gcode: RESUME
switch_pin: !PC15

[heater_bed]
heater_pin: PA7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
#control: pid
#pid_Kp: 69.139
#pid_Ki: 1.273
#pid_Kd: 938.565
min_temp: 0
max_temp: 100 # I highly recommend putting "reflectix" under the bed

[heater_fan hotend_fan]
pin: PC0
heater: extruder
heater_temp: 50.0

[fan]
pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 3000
max_accel_to_decel: 3000
max_z_velocity: 5
square_corner_velocity: 5.0
max_z_accel: 100

[bltouch]
sensor_pin: ^PC14 
control_pin: PC13 
x_offset: -32
y_offset: -41
#z_offset: 2.80
speed:10
samples:1
samples_result:average
probe_with_touch_mode: true
stow_on_each_sample: false

[safe_z_home]
home_xy_position: 154,154
speed: 200
z_hop: 10
z_hop_speed: 5

[bed_mesh]
speed: 200
mesh_min: 10, 20
mesh_max: 215, 180
algorithm: bicubic
probe_count: 10,10

[temperature_sensor Board_MCU]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[firmware_retraction]
retract_length: 0.8
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
#   The Ender 3 S1 has a direct drive with factory recommendations for 0.8mm
retract_speed: 40
#   The speed of retraction, in mm/s. The default is 20 mm/s.
#   The Ender 3 S1 has a direct drive with factory recommendations of 35-45mm/s
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 40
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]

# Nozzle cleaning: see https://www.printables.com/model/405482-nozzle-wiper-holder-x-axis-ender-3-s1
[gcode_macro Clean_Nozzle]
gcode:
  G90
  G1 X220 Y0 Z15 F6000
  G1 X247 F6000
  G1 X220 F6000
  G1 X247 F6000
  G1 X220 F6000
  G1 X247 F6000
  G1 X220 F6000
  G1 X247 F6000
  G1 X220 F6000
  G1 X247 F6000
  G1 X220 F6000

# Set up Klipper's automatic assist with physical bed levelling
# See https://blog.ollien.com/posts/klipper-leveling/
# Note that we can't get ALL the way to the back screws on the S1
# Use SCREWS_TILT_CALCULATE
[screws_tilt_adjust]
screw1: 57, 72
screw1_name: front left screw
screw2: 232, 72
screw2_name: front right screw
screw3: 232, 225
screw3_name: rear right screw
screw4: 57, 225
screw4_name: rear left screw
horizontal_move_z: 10
speed: 100
screw_thread: CW-M4
  
[pause_resume]

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %} 

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}  
  RESUME_BASE {get_params}

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 2.110
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.025000, -0.157500, -0.097500, -0.157500, -0.225000, -0.120000, -0.127500, -0.200000, -0.082500, 0.135000
#*# 	  0.005000, -0.137500, -0.090000, -0.155000, -0.227500, -0.132500, -0.137500, -0.195000, -0.072500, 0.140000
#*# 	  0.107500, -0.052500, -0.005000, -0.082500, -0.165000, -0.082500, -0.090000, -0.162500, -0.035000, 0.180000
#*# 	  0.117500, -0.022500, 0.022500, -0.045000, -0.125000, -0.045000, -0.055000, -0.130000, -0.015000, 0.185000
#*# 	  0.115000, -0.027500, 0.027500, -0.032500, -0.110000, -0.015000, -0.037500, -0.122500, 0.000000, 0.200000
#*# 	  0.125000, -0.010000, 0.040000, -0.012500, -0.085000, 0.012500, -0.017500, -0.105000, -0.002500, 0.180000
#*# 	  0.172500, 0.012500, 0.057500, -0.005000, -0.085000, 0.007500, -0.032500, -0.130000, -0.020000, 0.165000
#*# 	  0.187500, 0.020000, 0.055000, -0.010000, -0.087500, 0.000000, -0.030000, -0.112500, -0.010000, 0.172500
#*# 	  0.205000, 0.027500, 0.062500, -0.020000, -0.105000, -0.017500, -0.040000, -0.125000, -0.010000, 0.180000
#*# 	  0.202500, 0.027500, 0.052500, -0.025000, -0.112500, -0.030000, -0.050000, -0.130000, -0.030000, 0.150000
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 11.479999999999997
#*# max_x = 214.96
#*# min_y = 20.0
#*# max_y = 179.92
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.903
#*# pid_ki = 0.795
#*# pid_kd = 124.641
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.889
#*# pid_ki = 1.155
#*# pid_kd = 968.215
